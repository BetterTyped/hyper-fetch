---
sidebar_position: 2
---

```tsx
export const builder = new FetchBuilder({ baseUrl })
  .onAuth((command) => {
    const state = store.getState();
    const authToken = state.auth.token;

    // Before each command with setting "auth: true" add the Bearer token
    return command.setHeaders({
      ...command.headers,
      Authorization: `Bearer ${authToken}`,
    });
  })
  .onError(async (res, command) => {
    const status = res[2];
    const refreshToken = localStorage.getItem(REFRESH_TOKEN_STORAGE_FIELD);

    // Check if command has the used value - this will ensure you will not go into infinite loop
    if (!command.used && refreshToken && status === 401) {
      // Prepare the refresh token command
      const postRefreshToken = builder.createCommand<LoginResponse, LoginData>()({
        endpoint: "/refresh-token",
        method: "POST",
      });

      // Call the command to receive new tokens
      const [data] = await postRefreshToken.setData({ refreshToken }).exec();

      if (data) {
        // Safe the new tokens
        localStorage.setItem(TOKEN_STORAGE_FIELD, data.token);
        localStorage.setItem(REFRESH_TOKEN_STORAGE_FIELD, data.refreshToken);
        // Repeat the request
        return command.setUsed(true).send();
      }
    }
    // Return the initial response is something goes wrong
    return res;
  });
```
